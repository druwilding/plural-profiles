-# Recursive tree node for the explorer sidebar.
-# Locals: node (hash with :group, :profiles, :children)
-#   node[:profiles] entries are hashes with :profile and :repeated (set by the model).
- group = node[:group]
- profile_entries = Array(node[:profiles])
- children = Array(node[:children])
- has_children = children.any? || profile_entries.any?

- if has_children
  %li.tree__folder{role: "treeitem", "aria-expanded": "true"}
    .tree__row
      %span.tree__arrow-btn{role: "button", tabindex: "0", "data-action": "click->tree#toggleFolder keydown->tree#toggleFolder", "aria-label": "Toggle #{group.name}"}
        %span.tree__arrow.tree__arrow--open{"aria-hidden": "true"} â–¶
      = link_to group_path(group.uuid), class: "tree__item", "data-action": "click->tree#selectGroup", "data-panel-url": panel_group_path(group.uuid), "data-group-uuid": group.uuid do
        - if group.avatar.attached?
          = image_tag group.avatar.variant(resize_to_fill: [24, 24]), class: "tree__avatar", width: 24, height: 24, alt: ""
        %span.tree__label= group.name
    %ul.tree__children{role: "group"}
      - children.each do |child_node|
        = render "groups/tree_node", node: child_node
      - profile_entries.each do |entry|
        - profile = entry[:profile]
        - repeated = entry[:repeated]
        %li.tree__leaf{role: "treeitem"}
          = link_to group_profile_path(group.uuid, profile.uuid), class: "tree__item", "data-action": "click->tree#selectProfile", "data-panel-url": panel_group_profile_path(group.uuid, profile.uuid), "data-group-uuid": group.uuid, "data-profile-uuid": profile.uuid do
            - if profile.avatar.attached?
              = image_tag profile.avatar.variant(resize_to_fill: [24, 24]), class: "tree__avatar", width: 24, height: 24, alt: ""
            - else
              %span.tree__avatar.tree__avatar--placeholder{"aria-hidden": "true"}
                = render "shared/plural_pride_logo"
            - if repeated
              %span.tree__label.tree__label--repeated{title: "#{profile.name} also appears elsewhere in this group"}
                = profile.name
                %span.visually-hidden= " (also appears elsewhere in this group)"
            - else
              %span.tree__label= profile.name
- else
  %li.tree__folder{role: "treeitem"}
    .tree__row
      %span.tree__arrow-btn{"aria-hidden": "true"}
        %span.tree__arrow
      = link_to group_path(group.uuid), class: "tree__item", "data-action": "click->tree#selectGroup", "data-panel-url": panel_group_path(group.uuid), "data-group-uuid": group.uuid do
        - if group.avatar.attached?
          = image_tag group.avatar.variant(resize_to_fill: [24, 24]), class: "tree__avatar", width: 24, height: 24, alt: ""
        %span.tree__label= group.name
