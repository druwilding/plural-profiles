- content_for(:title) { @group.name + " — Plural Profiles" }
- content_for(:head) do
  %meta{property: "og:title", content: @group.name}
  %meta{property: "og:site_name", content: "Plural Profiles"}
  %meta{property: "og:type", content: "website"}
  %meta{property: "og:url", content: group_url(@group.uuid)}
  - if @group.description.present?
    %meta{property: "og:description", content: truncate(strip_tags(@group.description), length: 200)}
  - if @group.avatar.attached?
    %meta{property: "og:image", content: rails_representation_url(@group.avatar.variant(resize_to_fill: [512, 512]))}
    %meta{property: "og:image:width", content: "512"}
    %meta{property: "og:image:height", content: "512"}

- has_tree = @descendant_tree.any? || @direct_profiles.any?

- if has_tree
  .explorer{"data-controller": "tree"}
    .explorer__sidebar
      %ul.tree
        -# Root group node
        %li.tree__folder{"data-tree-target": "folder"}
          %button.tree__toggle.tree__toggle--active{"data-action": "click->tree#selectRoot", type: "button"}
            %span.tree__arrow ▸
            - if @group.avatar.attached?
              = image_tag @group.avatar.variant(resize_to_fill: [20, 20]), class: "tree__avatar", width: 20, height: 20, alt: ""
            %span.tree__label= @group.name
          %ul.tree__children
            -# Child groups (recursive)
            - @descendant_tree.each do |node|
              = render "groups/tree_node", node: node, root_group: @group
            -# Direct profiles at root level
            - @direct_profiles.each do |profile|
              %li.tree__leaf
                %button.tree__item{"data-action": "click->tree#selectProfile", "data-group-uuid": @group.uuid, "data-profile-uuid": profile.uuid, type: "button"}
                  - if profile.avatar.attached?
                    = image_tag profile.avatar.variant(resize_to_fill: [20, 20]), class: "tree__avatar", width: 20, height: 20, alt: ""
                  - else
                    %span.tree__avatar.tree__avatar--placeholder= profile.name.first.upcase
                  %span.tree__label= profile.name

    .explorer__content{"data-tree-target": "content"}
      -# Default: show root group content
      = render "groups/group_content", group: @group, profiles: @direct_profiles

    -# Hidden content panels for each descendant group
    - @descendant_tree.flatten(1) rescue nil
    - cache_tree = lambda do |nodes|
      - nodes.each do |node|
        %template{"data-tree-target": "groupTemplate", "data-group-uuid": node[:group].uuid}
          = render "groups/group_content", group: node[:group], profiles: node[:profiles]
        - node[:profiles].each do |profile|
          %template{"data-tree-target": "profileTemplate", "data-group-uuid": node[:group].uuid, "data-profile-uuid": profile.uuid}
            = render "groups/profile_content", group: node[:group], profile: profile
        - cache_tree.call(node[:children])
    - cache_tree.call(@descendant_tree)

    -# Templates for direct profiles
    - @direct_profiles.each do |profile|
      %template{"data-tree-target": "profileTemplate", "data-group-uuid": @group.uuid, "data-profile-uuid": profile.uuid}
        = render "groups/profile_content", group: @group, profile: profile

    -# Template for root group
    %template{"data-tree-target": "groupTemplate", "data-group-uuid": @group.uuid}
      = render "groups/group_content", group: @group, profiles: @direct_profiles

- else
  .card.profile-public
    .profile-header
      - if @group.avatar.attached?
        = link_to rails_blob_path(@group.avatar, disposition: "inline"), target: "_blank", rel: "noopener", title: "Click to see full size" do
          = image_tag @group.avatar.variant(resize_to_fill: [96, 96]), class: "avatar avatar--large", width: 96, height: 96, alt: @group.avatar_alt_text.presence || ""

    %div
      %h1= @group.name

    - if @group.description.present?
      .group-description
        = simple_format(@group.description)

  .card
    %p No profiles in this group yet.
