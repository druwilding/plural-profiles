- content_for(:title) { @group.name + " — Plural Profiles" }
- content_for(:head) do
  %meta{property: "og:title", content: @group.name}
  %meta{property: "og:site_name", content: "Plural Profiles"}
  %meta{property: "og:type", content: "website"}
  %meta{property: "og:url", content: group_url(@group.uuid)}
  - if @group.description.present?
    %meta{property: "og:description", content: truncate(strip_tags(@group.description), length: 200)}
  - if @group.avatar.attached?
    %meta{property: "og:image", content: rails_representation_url(@group.avatar.variant(resize_to_fill: [512, 512]))}
    %meta{property: "og:image:width", content: "512"}
    %meta{property: "og:image:height", content: "512"}

- has_tree = @descendant_tree.any? || @direct_profiles.any?

- if has_tree
  %div{"data-controller": "tree"}
    .explorer
      .explorer__sidebar{role: "tree", "aria-label": "#{@group.name} navigation"}
        %ul.tree
          -# Root group node
          %li.tree__folder{role: "treeitem", "aria-expanded": "true"}
            .tree__row
              %span.tree__arrow-btn{role: "button", tabindex: "0", "data-action": "click->tree#toggleFolder keydown->tree#toggleFolder", "aria-label": "Toggle #{@group.name}"}
                %span.tree__arrow.tree__arrow--open{"aria-hidden": "true"} ▶
              = link_to group_path(@group.uuid), class: "tree__item tree__item--active", "data-action": "click->tree#selectRoot", "data-panel-url": panel_group_path(@group.uuid), "data-group-uuid": @group.uuid do
                - if @group.avatar.attached?
                  = image_tag @group.avatar.variant(resize_to_fill: [24, 24]), class: "tree__avatar", width: 24, height: 24, alt: ""
                %span.tree__label= @group.name
            %ul.tree__children{role: "group"}
              -# Child groups (recursive)
              - @descendant_tree.each do |node|
                = render "groups/tree_node", node: node
              -# Direct profiles at root level
              - @direct_profiles.each do |profile|
                - repeated = @seen_profile_ids.include?(profile.id)
                - @seen_profile_ids.add(profile.id)
                %li.tree__leaf{role: "treeitem"}
                  = link_to group_profile_path(@group.uuid, profile.uuid), class: "tree__item", "data-action": "click->tree#selectProfile", "data-panel-url": panel_group_profile_path(@group.uuid, profile.uuid), "data-group-uuid": @group.uuid, "data-profile-uuid": profile.uuid do
                    - if profile.avatar.attached?
                      = image_tag profile.avatar.variant(resize_to_fill: [24, 24]), class: "tree__avatar", width: 24, height: 24, alt: ""
                    - else
                      %span.tree__avatar.tree__avatar--placeholder{"aria-hidden": "true"}
                        = render "shared/plural_pride_logo"
                    - if repeated
                      %span.tree__label.tree__label--repeated{title: "Also appears elsewhere in this group"}
                        = profile.name
                    - else
                      %span.tree__label= profile.name

      .explorer__content{"data-tree-target": "content", "aria-live": "polite"}
        -# Default: show root group content
        = render "groups/group_content", group: @group, profiles: @direct_profiles

    -# No-JS fallback: all content rendered flat with linked profile cards
    .explorer__fallback{"data-tree-target": "fallback"}
      = render "groups/group_content_fallback", group: @group, profiles: @direct_profiles
      - render_flat = lambda do |nodes|
        - nodes.each do |node|
          - if node[:profiles].any? || node[:children].any?
            %h2
              - if node[:group].avatar.attached?
                = image_tag node[:group].avatar.variant(resize_to_fill: [32, 32]), class: "avatar avatar--inline", width: 32, height: 32, alt: ""
              = link_to node[:group].name, group_path(node[:group].uuid)
            - if node[:profiles].any?
              .profile-grid
                - node[:profiles].each do |entry|
                  = render "groups/profile_card", group: node[:group], profile: entry[:profile]
            - render_flat.call(node[:children])
      - render_flat.call(@descendant_tree)

- else
  .card.profile-public
    .profile-header
      - if @group.avatar.attached?
        = link_to rails_blob_path(@group.avatar, disposition: "inline"), target: "_blank", rel: "noopener", title: "Click to see full size" do
          = image_tag @group.avatar.variant(resize_to_fill: [96, 96]), class: "avatar avatar--large", width: 96, height: 96, alt: @group.avatar_alt_text.presence || ""

    %div
      %h1= @group.name

    - if @group.description.present?
      .group-description{data: {controller: "spoiler", action: "click->spoiler#toggle keydown->spoiler#keydown"}}
        = formatted_description(@group.description)
