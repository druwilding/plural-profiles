- content_for(:title) { "Manage groups in #{@group.name} — Plural Profiles" }

%h1
  Manage groups in
  = @group.name

%h2 Current groups

- if @child_links.any?
  .card-list
    - @child_links.each do |link|
      - child = link.child_group
      .card.card--row
        .card__header
          - if child.avatar.attached?
            = image_tag child.avatar.variant(resize_to_fill: [40, 40]), class: "avatar avatar--small", width: 40, height: 40, alt: child.avatar_alt_text.presence || ""
          - else
            .avatar.avatar--small.avatar--placeholder
              = render "shared/plural_pride_logo"
          %div
            %span= child.name
            - if child.child_links.any?
              -# Inline form to choose inclusion_mode and optional selected sub-groups
              = form_with url: update_relationship_our_group_path(@group, group_id: child.id), method: :patch, local: false, class: "inclusion-form" do |f|
                .inclusion-row
                  %fieldset.inclusion-radios
                    %legend Include sub-groups
                    %label
                      = radio_button_tag "inclusion_mode", "all", link.all?, id: "inclusion_#{link.id}_all"
                      All
                    %label
                      = radio_button_tag "inclusion_mode", "none", link.none?, id: "inclusion_#{link.id}_none"
                      None
                    %label
                      = radio_button_tag "inclusion_mode", "selected", link.selected?, id: "inclusion_#{link.id}_selected"
                      Selected

                  %fieldset.inclusion-checkboxes
                    %legend Select sub-groups
                    .checkbox-list
                      - child.child_groups.order(:name).each do |sub|
                        - checked = if link.all? then true elsif link.none? then false else Array(link.included_subgroup_ids).map(&:to_i).include?(sub.id) end
                        %label.checkbox{for: "included_#{link.id}_#{sub.id}"}
                          = check_box_tag "included_subgroup_ids[]", sub.id, checked, id: "included_#{link.id}_#{sub.id}"
                          %span= sub.name

                = f.submit "Save", class: "btn btn--small"
        = link_to "Remove", remove_group_our_group_path(@group, group_id: child.id), data: { turbo_method: :delete }, class: "btn btn--danger btn--small"
- else
  .card
    %p No groups have been added to this group.

%h2 Add a group

- if @available_groups.any?
  .card-list
    - @available_groups.each do |group|
      .card.card--row
        .card__header
          - if group.avatar.attached?
            = image_tag group.avatar.variant(resize_to_fill: [40, 40]), class: "avatar avatar--small", width: 40, height: 40, alt: group.avatar_alt_text.presence || ""
          - else
            .avatar.avatar--small.avatar--placeholder
              = render "shared/plural_pride_logo"
          %span= group.name
        = link_to "Add", add_group_our_group_path(@group, group_id: group.id), data: { turbo_method: :post }, class: "btn btn--small"
- else
  .card
    %p
      - if Current.user.groups.count > 1
        All your other groups are already in this group.
      - else
        You need to
        = link_to "create more groups", new_our_group_path
        first.

%p= link_to "← Back to group", our_group_path(@group)

:javascript
  document.addEventListener('change', function(e) {
    var el = e.target;
    if (!el.closest) return;
    var form = el.closest('.inclusion-form');
    if (!form) return;
    if (el.name === 'inclusion_mode') {
      var mode = el.value;
      var checkboxes = form.querySelectorAll('input[name="included_subgroup_ids[]"]');
      if (mode === 'all') {
        checkboxes.forEach(function(cb){ cb.checked = true; });
      } else if (mode === 'none') {
        checkboxes.forEach(function(cb){ cb.checked = false; });
      }
    }
  });
